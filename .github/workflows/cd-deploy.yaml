name: CD - Deploy to Kubernetes

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout K8s Config Repo
      uses: actions/checkout@v4

    - name: Determine Overlay Path
      id: set_overlay_path
      run: |
        if ("${{ github.ref }}" -eq "refs/heads/develop") {
          echo "overlay_path=overlays/qa" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "environment_name=QA" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        }
        elseif ("${{ github.ref }}" -eq "refs/heads/main") {
          echo "overlay_path=overlays/prod" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          echo "environment_name=PRO" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        }
        else {
          echo "No se pudo determinar el entorno de despliegue. Saliendo."
          exit 1
        }

    - name: Imprimir directorio de trabajo
      run: |
        Write-Output "Directorio actual: $(Get-Location)"

    - name: Get available contexts
      run: |
        kubectl config get-contexts
        $context = kubectl config current-context
        echo "current_context=$context" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8


    - name: Verify kubectl connection
      env:
        KUBECONFIG:  ${{ env.USERPROFILE }}\.kube\config
      run: |
        echo "Verificando configuraci√≥n de kubectl..."
        kubectl config get-contexts
        kubectl config use-context docker-desktop
        kubectl cluster-info
        kubectl config current-context





    - name: Deploy to ${{ steps.set_overlay_path.outputs.environment_name }}
      env:
        KUBECONFIG:  ${{ env.USERPROFILE }}\.kube\config
      run: |
        echo "Desplegando a ${{ steps.set_overlay_path.outputs.environment_name }} usando ${{ steps.set_overlay_path.outputs.overlay_path }}"
        kubectl apply -k ${{ steps.set_overlay_path.outputs.overlay_path }} --validate=false

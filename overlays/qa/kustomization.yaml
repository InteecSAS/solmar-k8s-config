# overlays/qa/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

configMapGenerator:
- files:
  - qa-config.properties
  name: solmar-config-qa

# Genera el Secret leyendo el archivo .env (Kustomize lo codifica por ti)
secretGenerator:
- envs:
  - qa-secrets.env
  name: solmar-secrets-qa

# Aplica los patches de imagen y réplicas
patches:
- path: replicas.yaml
  target:
    kind: Deployment

# Aplica el parche de variables de entorno a TODOS los Deployments
- patch: |-
    - op: add
      path: /spec/template/spec/containers/0/envFrom
      value:
        - configMapRef:
            name: solmar-config-qa
        - secretRef:
            name: solmar-secrets-qa
  target:
    kind: Deployment

# Parche específico para notifications-service
- patch: |-
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts
      value:
        - name: firebase-secret-volume
          mountPath: "/etc/firebase"
          readOnly: true
    - op: add
      path: /spec/template/spec/volumes
      value:
        - name: firebase-secret-volume
          secret:
            secretName: firebase-admin-sdk
    - op: add
      path: /spec/template/spec/containers/0/env
      value:
        - name: Firebase__ServiceAccountKeyPath
          value: "/etc/firebase/firebase-adminsdk.json"
  target:
    kind: Deployment
    name: notifications-service
resources:
- ../../base
images:
- name: diurvan/solmar-backend-authservice
  newName: diurvan/solmar-backend-authservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-catalogservice
  newName: diurvan/solmar-backend-catalogservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-finanzasservice
  newName: diurvan/solmar-backend-finanzasservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-localizationservice
  newName: diurvan/solmar-backend-localizationservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-mediaservice
  newName: diurvan/solmar-backend-mediaservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-membershipsservice
  newName: diurvan/solmar-backend-membershipsservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-notificationsservice
  newName: diurvan/solmar-backend-notificationsservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-reservationsservice
  newName: diurvan/solmar-backend-reservationsservice
  newTag: 1b949a6
- name: diurvan/solmar-backend-yarpproxy
  newName: diurvan/solmar-backend-yarpproxy
  newTag: 1b949a6
